# IM-Service

即时通讯-服务器

# golang开发须知

1.如果想用go get依赖自己的gitee/github/gitlab库
go.mod的名字必须是项目的远程路径

2.服务之间用rpcx进行通信，rpcx以protobuf插件的形式编译得到，具体用法可参考rpcx插件：https://gitee.com/mimis/protoc-gen-rpcx

3.客户端与服务器之间的信息交互使用tcp的方式，交互形式是一个req对应一个res

4.服务器消息发送可以是客户端请求返回，也可以是主动调用

5.protoc版本:3.20.1

# 数据库反转工具xorm reverse
https://github.com/laixyz/reverse, 使用xorm -f xxx(yaml配置文件路径)

原版将数据库url放在yaml文件conn_str字段, 项目中修改为命令行参数输入
原版: xorm -f dbmodel/reverse/custom.yaml
改版: xorm -f dbmodel/reverse/custom.yaml --dsn 'root:dev123@tcp(localhost:3306)/im_zhangbin?charset=utf8'

# 数据库结构生成
tools/sql_tools/db_sync.go文件
命令行: go run db_sync.go -d im_zhangbin -u root -p dev123

# 未解决的困难
* html iframe切换不同界面是无状态的, 也就是客户端要保存已经存在的数据是需要更大的代价
由于网页版客户端开发消耗了大量的时间,而且达不到预期的效果, 所以先考虑开发更友好的QT版客户端
尽量不在界面客户端开发浪费大量的时间, 主要目的是编写一个用于即时通讯的网络服务器
* 客户端输入编辑框暂时无法插入文件样式, 所以文件发送不在编辑框中展示,直接发送显示在聊天消息中, 希望后续能够改进支持


# 功能简要
* 文件传输支持格式:txt, html, pdf, css, zip, mp3, mp4(其它文件也可以传输, 但客户端不支持显示)

# 优化内容
## 1: friends好友表优化
```
原版: friends好友数据表结构是所有的好友申请/好友列表等信息都放在一个json里面存储<br>
改版: friends表由roleid和friendid索引, status状态标记好友状态(申请中/正常好友/拉黑), 还有亲密度,成为好友时间等字段,
      可使用这些字段进行排序, 好友表需要分表处理
```
## 2: 玩家状态设置优化
```
由于tcp断开之后read函数检测到短线需要一定的时间, 而在这个时间段, 可能玩家自动重连上来了, 这个时候就会出现login消息比logout消息提前到达,
这个时候玩家状态会被设置为离线
解决方案: 登录的时候发现状态为在线, 继续登录, 当logout消息到达的时候直接主动断开和客户端的连接, 客户端发现断连之后出发重连机制
```
# 开发进度
## 功能开发暂时搁置,后续将重点放在架构开发
目前计划在当前架构的基础上, 使用**DDD领域驱动设计**, 将每个服务继续往下拆分领域层,实体层,数据层

# 服务器
- [x] 基本网络框架, 网页websocket, 客户端TCP, 各个服务之间rpcx
- [x] 数据库管理,导出,导入工具xorm, 每个服务dao的完善
- [x] gateway网关服搭建基本完成, 完成接收, 发送消息
- [x] home大厅服搭建基本完成, 能解析,编码,分发消息
- [x] 记录客户端的登录,注册信息,正常转发聊天消息
- [x] 数据库读写分离
- [x] 优化用户在线,离线状态判断
- [x] 搭建分布式文件系统,存放头像,聊天记录
- [x] 优化启服配置,规范为yaml文件读取启服信息
- [x] 存储离线消息,并在客户端登录的时候发送离线消息
- [x] 日志输出,分割系统
- [x] 好友离线申请存储转发优化
- [x] 好友聊天图片转发和存储
- [x] 废弃离线消息redis存储, 离线消息占用redis过多内存, 数据量大了之后redis内存就不够了(暂时改为redis标记存在离线消息)
- [ ] 实现文件离线上传和下载
- [ ] 实现文件实时在线的P2P传输

# 客户端(网页版)-暂停开发
- [x] 使用websocket正常连接服务器, 并发送和接收消息
- [x] 登录界面搭建(UI和布局先不考虑), 能够正常登录服务器
- [x] 搭建简易主界面, 能和服务器发送消息
- [ ] 刷新页面也能保持登录
- [ ] 给好友发送消息
- [ ] 添加, 删除好友

# 客户端(桌面版)-暂停开发
- [x] 简单的日志收集系统
- [x] 建立网络模型和服务器进行通信
- [x] 登录,注册功能实现
- [x] 基础控件库搭建,控件的样式功能都可复用(这个可能会持续整个客户端结束)
- [x] 好友系统搭建, 实现添加,删除好友功能
- [x] 和好友正常聊天发消息
- [x] 优化客户端网络模型,将socket通信层和业务层分离出来, 可以实现阻塞调用和注册回调调用
- [x] 为网络模块添加阻塞调用, 能正常进行阻塞调用通信
- [x] 设置本地存储, 将好友的聊天记录等内容存储到本地,下次登录的时候先从本地读取,再从服务器获取离线消息
- [x] 好友离线申请获取展示优化
- [x] 好友聊天图片的发送,接收和存储
- [ ] 和服务器交互文件的基础信息, 文件上传和下载不和业务服务器交互
